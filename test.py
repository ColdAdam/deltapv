import unittest
import jaxpv
from jax import numpy as np

L = 3e-4
grid = np.linspace(0, L, 500)
design = jaxpv.simulator.create_design(grid)
material = jaxpv.materials.create_material(Chi=3.9,
                                           Eg=1.5,
                                           eps=9.4,
                                           Nc=8e17,
                                           Nv=1.8e19,
                                           mn=100,
                                           mp=100,
                                           Et=0,
                                           tn=1e-8,
                                           tp=1e-8,
                                           A=1e4)
design = jaxpv.simulator.add_material(design, material, lambda x: True)
design = jaxpv.simulator.contacts(design, 1e7, 0, 0, 1e7)
design = jaxpv.simulator.single_pn_junction(design, 1e17, -1e15, 50e-7)
ls = jaxpv.simulator.incident_light()


class TestJAXPV(unittest.TestCase):
    def test_iv(self):

        results = jaxpv.simulator.simulate(design, ls)
        v, j = results["iv"]

        v_correct = [
            0.0, 0.02385882199287483, 0.04771764398574966, 0.07157646597862448,
            0.09543528797149932, 0.11929410996437415, 0.14315293195724896,
            0.1670117539501238, 0.19087057594299864, 0.21472939793587345,
            0.2385882199287483, 0.2624470419216231, 0.2863058639144979,
            0.3101646859073728, 0.3340235079002476, 0.3578823298931224,
            0.3817411518859973, 0.4055999738788721, 0.4294587958717469,
            0.45331761786462177, 0.4771764398574966, 0.5010352618503714,
            0.5248940838432462, 0.548752905836121, 0.5726117278289958,
            0.5964705498218708, 0.6203293718147456, 0.6441881938076204,
            0.6680470158004952, 0.69190583779337, 0.7157646597862448,
            0.7396234817791196, 0.7634823037719946, 0.7873411257648694,
            0.8111999477577442, 0.835058769750619, 0.8589175917434938,
            0.8827764137363686, 0.9066352357292435, 0.9304940577221184
        ]

        j_correct = [
            0.01882799450659129, 0.018792826040510732, 0.018756855158670305,
            0.018720051264372563, 0.018682381724448492, 0.01864381194400253,
            0.018604305002608516, 0.018563821577693138, 0.018522319459466936,
            0.018479753716101673, 0.0184360758755966, 0.018391233984793986,
            0.01834517194209354, 0.01829782914762203, 0.018249139956473644,
            0.018199032889491477, 0.018147429783087473, 0.018094244484459576,
            0.01803938092537839, 0.017982729938213992, 0.017924163829131798,
            0.017863526571736198, 0.017800617043701894, 0.01773515986437786,
            0.017666758342104526, 0.017594818430834245, 0.01751842730029611,
            0.01743615241474616, 0.017345697290762185, 0.01724329394187267,
            0.017122603507635826, 0.01697267632048231, 0.016774053568950974,
            0.016491071370720152, 0.016056151921708874, 0.015336708744230031,
            0.01406347852550213, 0.01167204746756459, 0.006948520665606761,
            -0.0027591825027920886
        ]

        self.assertTrue(np.allclose(v, v_correct), "Voltages do not match!")
        self.assertTrue(np.allclose(j, j_correct), "Currents do not match!")


if __name__ == '__main__':
    unittest.main()
